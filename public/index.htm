<!DOCTYPE html>
<html>
	<head>
		<title><%= config.application.name%> | <%= config.application.slogan %></title>
		<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
		<meta name="viewport" content="width=device-width" />
		<link rel="Stylesheet" href="css/style.css" type="text/css" />
		<script src="js/jquery.js"></script>
		<script src="js/angular.min.js"></script>
		<script src="js/controllers.js"></script>
		<script src="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
	</head>

	<body ng-app="nodejukeboxApp">

		<div data-role="page" data-theme="a">
			<div data-role="header">
				<h1><%= config.application.name%></h1>
				<a href="#left-panel" data-icon="bars" data-iconpos="notext" data-shadow="false" data-iconshadow="false"></a>
			</div>
			<div data-role="content" ng-controller="SearchResultCtrl">
				<ul data-role="listview" data-divider-theme="" data-inset="false">
					<li ng-show="search_results.length > 0" data-role="list-divider" data-theme="c">Search Results</li>
					<li ng-repeat="search_result in search_results" ng-class="{disabled: sync.playlist.indexOf(search_result) == -1}" data-theme="c">
						<a href="#" data-transition="slide" data-url="{{search_result.id}}" title="Add {{search_result.title}} to playlist">
							<img ng-src="{{search_result.thumbnail.hqDefault}}" alt="{{search_result.title}}" />
							<h2>{{search_result.title}}</h2>
							<p>{{search_result.uploader}}</p>
						</a>
					</li>
				</ul>
			</div>
			<div data-role="panel" id="left-panel" data-theme="a" data-display="overlay">
				<ul data-role="listview">
					<li data-role="list-divider">Menu</li>
					<li>
						<form id="searchYouTube">
							<input name="q" placeholder="Search YouTube" value="" type="search" />							
						</form>
					</li>
					<li><a href="#" data-rel="">Playlist</a></li>
					<li><a href="#" data-rel="">Now Playing</a></li>
				</ul>
			</div>
		</div>
		<script>
			var socket = io.connect();
			var sync = {now_playing: 0, playlist: []};
			$('#searchYouTube').submit(function(event){
				var search_query = $(this).find('input[name="q"]').val();
				if(search_query != ""){
					socket.emit('search', {query: search_query});
					$('#left-panel').panel('close');
					var $this = $(document),
						theme = $this.jqmData( "theme" ) || $.mobile.loader.prototype.options.theme,
						msgText = $this.jqmData( "msgtext" ) || $.mobile.loader.prototype.options.text,
						textVisible = $this.jqmData( "textvisible" ) || $.mobile.loader.prototype.options.textVisible,
						textonly = !!$this.jqmData( "textonly" );
						html = $this.jqmData( "html" ) || "";
					$.mobile.loading( "show", {
						text: msgText,
						textVisible: textVisible,
						theme: theme,
						textonly: textonly,
						html: html
					});
				}
				event.stopPropagation();
				event.preventDefault();
			});
			socket.on('youtube-search-results', function(data){
				angular.element($('div[data-role="content"]')).scope().$apply(function ($scope){
					var search_results = [];
					$.each(data.items, function(index, val){
						search_results.push(val);
					});
					$scope.search_results = search_results;
				});
				$.mobile.loading("hide");
				$('ul[data-role="listview"]').listview('refresh');
			});
			socket.on('sync', function(sync){
				//var sync = sync; //Sync the playlist as well as updating the currently playing song
				console.log(sync);
			});
			$('div[data-role="content"]').on('click', 'a', function(event){
				var video_id = $(this).attr('data-url');
				socket.emit('add_song', video_id);
				event.preventDefault();
				event.stopPropagation();
			});
		</script>
	</body>
</html>